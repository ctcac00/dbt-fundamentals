version: 2

models:
  - name: dim_customers
    description: "Customers dimension model."
    columns:
      - name: customer_id
        description: The primary key for customers.
        tests:
          - unique
          - not_null
          - dbt_utils.cardinality_equality:
              arguments:
                field: customer_id
                to: ref('stg_jaffle_shop__customers')
      - name: first_order_date
        description: NULL when a customer has not yet placed an order.
      - name: lifetime_value
        description: Lifetime value of a customer based on orders purchased
        tests:
          - average_dollars_spent_greater_than_one:
              arguments:
                group_by_column: customer_id
      - name: first_name
        description: First name of the customer
      - name: most_recent_order_date
        description: Date of the customer's most recent order

  - name: fct_orders
    description: "Orders fact model. This table's grain is one row per order."
    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "amount >= 0"
    columns:
      - name: order_id
        description: Primary key for orders
        tests:
          - unique
          - not_null
      - name: amount
        description: Dollars spent per order
        tests:
          - average_dollars_spent_greater_than_one:
              arguments:
                group_by_column: customer_id
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
                row_condition: "order_id is not null"
                strictly: false
          - dbt_expectations.expect_column_mean_to_be_between:
              arguments:
                min_value: 1
                group_by: [customer_id]
                row_condition: "order_id is not null"
                strictly: false
      - name: customer_id
        description: Foreign key to customers
        tests:
          - relationships:
              arguments:
                to: ref('stg_jaffle_shop__customers')
                field: customer_id
      - name: order_date
        description: Date the order was placed

semantic_models:
  - name: dim_customers
    description: "Semantic model for customers dimension"
    model: ref('dim_customers')
    defaults:
      agg_time_dimension: most_recent_order_date
    entities:
      - name: customer
        type: primary
        expr: customer_id
    dimensions:
      - name: first_order_date
        type: time
        type_params:
          time_granularity: day
      - name: customer_name
        type: categorical
        expr: first_name
      - name: most_recent_order_date
        type: time
        type_params:
          time_granularity: day
    measures:
      - name: customers_with_orders
        description: "Unique count of customers placing orders"
        agg: count_distinct
        expr: customer_id
      - name: count_lifetime_orders
        description: Total count of orders per customer.
        agg: sum
        expr: number_of_orders
      - name: lifetime_spend
        description: Gross customer lifetime spend inclusive of taxes.
        agg: sum
        expr: lifetime_value

  - name: fct_orders
    description: "Semantic model for orders fact table"
    model: ref('fct_orders')
    defaults:
      agg_time_dimension: order_date
    entities:
      - name: order_id
        type: primary
      - name: customer
        type: foreign
        expr: customer_id
    dimensions:
      - name: order_date
        type: time
        type_params:
          time_granularity: day
    measures:
      - name: order_total
        description: "Sum of orders value"
        agg: sum
        expr: amount
      - name: order_count
        description: "Count of orders"
        agg: sum
        expr: 1
      - name: large_order_count
        description: "Count of orders with order total over 20"
        agg: sum
        expr: 1
      - name: order_value_p99
        description: "99th percentile of order value"
        agg: percentile
        expr: amount
        agg_params:
          percentile: 0.99
      - name: order_total_for_cumulative
        description: The total amount for each order including taxes.
        agg: sum
        expr: amount

metrics:
  # Metrics from dim_customers
  - name: customers_with_orders
    label: "Customers with Orders"
    description: "Unique count of customers placing orders"
    type: simple
    type_params:
      measure: customers_with_orders

  - name: count_lifetime_orders
    label: "Lifetime Orders Count"
    description: Total count of orders per customer.
    type: simple
    type_params:
      measure: count_lifetime_orders

  - name: lifetime_spend
    label: "Lifetime Spend"
    description: Gross customer lifetime spend inclusive of taxes.
    type: simple
    type_params:
      measure: lifetime_spend

  # Metrics from fct_orders
  - name: order_total
    label: "Order Total"
    description: "Sum of orders value"
    type: simple
    type_params:
      measure: order_total

  - name: order_count
    label: "Order Count"
    description: "Number of orders"
    type: simple
    type_params:
      measure: order_count

  - name: large_orders
    label: "Large Orders"
    description: "Count of orders with order total over 20."
    type: simple
    type_params:
      measure: large_order_count
    filter: |
      {{ Metric('order_total', group_by=['order_id']) }} >=  20

  - name: order_value_p99
    label: "Order Value P99"
    description: "99th percentile of order value"
    type: simple
    type_params:
      measure: order_value_p99

  - name: avg_order_value
    label: "Average Order Value"
    description: "Average value of each order"
    type: ratio
    type_params:
      numerator: order_total
      denominator: order_count

  - name: cumulative_order_amount_mtd
    label: "Cumulative Order Amount MTD"
    description: "The month to date value of all orders"
    type: cumulative
    type_params:
      measure: order_total_for_cumulative

  - name: pct_of_orders_that_are_large
    label: "Percent of Large Orders"
    description: "Percent of orders that are large"
    type: derived
    type_params:
      expr: large_orders / order_count
      metrics:
        - large_orders
        - order_count
